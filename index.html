<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RE-MINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { padding: 12px; text-align: center; background: var(--surface); border-bottom: 1px solid #333; flex-shrink: 0; }
        h1 { font-family: 'Orbitron', sans-serif; color: var(--primary); margin: 0; font-size: 1.2rem; letter-spacing: 2px; }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 120px; }
        
        .message { max-width: 90%; padding: 12px; border-radius: 12px; line-height: 1.5; font-size: 0.95rem; word-wrap: break-word; }
        .user-message { align-self: flex-end; background: var(--primary); color: #000; font-weight: 600; }
        .ai-message { align-self: flex-start; background: var(--surface); border: 1px solid #333; width: 100%; box-sizing: border-box; }

        /* --- STUNNING MOBILE TABLE FIX --- */
        .table-container { width: 100%; overflow-x: auto; margin: 10px 0; border-radius: 8px; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; background: #252525; min-width: 300px; }
        th, td { border-bottom: 1px solid #333; padding: 10px; text-align: left; font-size: 0.85rem; }
        th { background: #333; color: var(--primary); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        tr:last-child td { border-bottom: none; }

        /* Input Bar */
        .input-container { position: fixed; bottom: 0; width: 100%; background: var(--surface); padding: 10px; box-sizing: border-box; border-top: 1px solid #333; z-index: 100; }
        .preview-container { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; }
        .preview-img { width: 55px; height: 55px; object-fit: cover; border-radius: 6px; border: 2px solid var(--primary); }
        
        .input-area { display: flex; align-items: center; gap: 10px; }
        input[type="text"] { flex: 1; background: #2b2b2b; border: 1px solid #444; color: #fff; padding: 12px 18px; border-radius: 25px; font-size: 16px; outline: none; }
        input[type="text"]:focus { border-color: var(--primary); }
        
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--primary); font-size: 1.6rem; padding: 5px; display: flex; align-items: center; justify-content: center; }

        .chat-image { width: 180px; border-radius: 10px; border: 2px solid var(--primary); align-self: flex-end; margin-bottom: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<header><h1>RE-MINE</h1></header>

<div id="chat-window">
    <div class="message ai-message">Welcome back. Upload photos of hardware for an urban mining analysis or ask me anything about e-waste.</div>
</div>

<div class="input-container">
    <div id="preview-container" class="preview-container"></div>
    <div class="input-area">
        <input type="file" id="fileInput" accept="image/*" multiple hidden>
        <button class="icon-btn" onclick="document.getElementById('fileInput').click()">ðŸ“Ž</button>
        <input type="text" id="userInput" placeholder="Type or upload...">
        <button class="icon-btn" onclick="sendMessage()">âž”</button>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('preview-container');

    fileInput.addEventListener('change', () => {
        previewContainer.innerHTML = '';
        for (const file of fileInput.files) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'preview-img';
            previewContainer.appendChild(img);
        }
    });

    async function sendMessage() {
        const text = document.getElementById('userInput').value;
        const files = Array.from(fileInput.files);
        
        if (!text && files.length === 0) return;

        // 1. Clear Preview and Input immediately
        previewContainer.innerHTML = '';
        document.getElementById('userInput').value = '';
        
        // 2. Add user text and images to the chat log
        if (text) appendMessage(text, 'user-message');
        files.forEach(file => {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'chat-image';
            chatWindow.appendChild(img);
        });

        const formData = new FormData();
        formData.append('text', text);
        files.forEach(file => formData.append('files', file));

        // 3. Smart Loading Message
        const statusText = files.length > 0 ? "Analyzing hardware components..." : "Thinking...";
        const loadingDiv = appendMessage(statusText, 'ai-message');
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
            const res = await fetch('/chat', { method: 'POST', body: formData });
            const data = await res.json();
            
            // 4. Reset file input for next use
            fileInput.value = ''; 

            loadingDiv.innerHTML = formatAI(data.response);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        } catch (e) {
            loadingDiv.innerText = "Error: Connection to server failed.";
        }
    }

    function appendMessage(txt, cls) {
        const div = document.createElement('div');
        div.className = `message ${cls}`;
        div.innerText = txt;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return div;
    }

    function formatAI(text) {
        // Formats Markdown bold and converts text tables into proper HTML tables
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        
        if (html.includes('|')) {
            const rows = html.split('<br>').filter(r => r.includes('|'));
            let tableHtml = '<div class="table-container"><table>';
            
            rows.forEach((row, index) => {
                if (row.includes('---')) return; // Skip separator row
                const cells = row.split('|').filter(c => c.trim() !== '');
                const tag = index === 0 ? 'th' : 'td';
                tableHtml += `<tr>${cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('')}</tr>`;
            });
            
            tableHtml += '</table></div>';
            // Replace the text-based table with our new HTML table
            html = html.replace(/(\|.*?\|(<br>|$))+/g, tableHtml);
        }
        return html;
    }
</script>

</body>
</html>
