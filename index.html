<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RE-MINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron&family=Inter:wght@300;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { padding: 15px; text-align: center; background: var(--surface); box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        h1 { font-family: 'Orbitron', sans-serif; color: var(--primary); margin: 0; font-size: 1.5rem; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 85%; padding: 10px 14px; border-radius: 12px; line-height: 1.4; font-size: 0.95rem; }
        .user-message { align-self: flex-end; background: var(--primary); color: #000; font-weight: 600; }
        .ai-message { align-self: flex-start; background: var(--surface); border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.85rem; }
        th, td { border: 1px solid #444; padding: 6px; text-align: left; }
        th { background: #333; color: var(--primary); }
        .input-area { padding: 15px; background: var(--surface); display: flex; align-items: center; gap: 10px; }
        input[type="text"] { flex: 1; background: #2b2b2b; border: 1px solid #444; color: #fff; padding: 10px 15px; border-radius: 20px; }
        button { background: none; border: none; cursor: pointer; color: var(--primary); font-size: 1.4rem; }
        .preview-container { display: flex; gap: 8px; padding: 0 15px 10px; overflow-x: auto; }
        .preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid var(--primary); }
    </style>
</head>
<body>
    <header><h1>RE-MINE</h1></header>
    <div id="chat-window"></div>
    <div id="preview-container" class="preview-container"></div>
    <div class="input-area">
        <input type="file" id="fileInput" accept="image/*" multiple hidden>
        <button onclick="document.getElementById('fileInput').click()">ðŸ“Ž</button>
        <input type="text" id="userInput" placeholder="Ask RE-MINE...">
        <button onclick="sendMessage()">âž”</button>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('preview-container');

        // Show thumbnails of photos before sending
        fileInput.addEventListener('change', () => {
            previewContainer.innerHTML = '';
            for (const file of fileInput.files) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview-img';
                previewContainer.appendChild(img);
            }
        });

        async function sendMessage() {
            const text = document.getElementById('userInput').value;
            const files = fileInput.files;
            if (!text && files.length === 0) return;

            // Display your message and images in the chat instantly
            if (text) appendMessage(text, 'user-message');
            for (const file of files) {
                const imgMsg = document.createElement('img');
                imgMsg.src = URL.createObjectURL(file);
                imgMsg.style.maxWidth = '150px';
                imgMsg.style.borderRadius = '10px';
                imgMsg.style.alignSelf = 'flex-end';
                chatWindow.appendChild(imgMsg);
            }

            const formData = new FormData();
            formData.append('text', text);
            for (let i = 0; i < files.length; i++) { formData.append('files', files[i]); }

            const loadingDiv = appendMessage("Analyzing...", 'ai-message');
            try {
                // Relative path '/' works locally and on Render
                const res = await fetch('/chat', { method: 'POST', body: formData });
                const data = await res.json();
                loadingDiv.innerHTML = formatAI(data.response);
            } catch (e) {
                loadingDiv.innerText = "Error: Check connection.";
            }

            document.getElementById('userInput').value = '';
            fileInput.value = '';
            previewContainer.innerHTML = '';
        }

        function appendMessage(txt, cls) {
            const div = document.createElement('div');
            div.className = `message ${cls}`;
            div.innerText = txt;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return div;
        }

        function formatAI(text) {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            if (html.includes('|')) {
                html = `<table>${html.replace(/\|(.+)\|/g, (m) => `<tr>${m.split('|').filter(c => c.trim()).map(c => `<td>${c}</td>`).join('')}</tr>`)}</table>`;
            }
            return html;
        }
    </script>
</body>
</html>
