<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RE-MINE Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .dashboard { background: var(--surface); padding: 10px 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .wealth-val { font-size: 1.2rem; font-weight: bold; color: var(--accent); cursor: pointer; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 160px; }
        .message { max-width: 90%; padding: 12px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; }
        .user-message { align-self: flex-end; background: var(--primary); color: #000; font-weight: bold; }
        .ai-message { align-self: flex-start; background: var(--surface); border: 1px solid #333; width: 100%; box-sizing: border-box; }
        .table-container { overflow-x: auto; margin: 10px 0; border: 1px solid #444; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; background: #252525; }
        td, th { padding: 8px; border-bottom: 1px solid #333; text-align: left; font-size: 0.8rem; }
        .input-container { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface); padding: 15px; border-top: 1px solid #333; z-index: 1000; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .control-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.7rem; color: var(--primary); font-family: 'Orbitron'; }
        .input-area { display: flex; align-items: center; gap: 10px; }
        input[type="text"] { flex: 1; background: #2b2b2b; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 20px; font-size: 16px; outline: none; }
        .btn { background: none; border: none; cursor: pointer; color: var(--primary); font-size: 1.6rem; display: flex; align-items: center; }
        .toggle-btn { font-size: 0.7rem; padding: 4px 8px; border: 1px solid var(--primary); border-radius: 4px; color: var(--primary); background: transparent; }
        .toggle-btn.active { background: var(--primary); color: #000; }
    </style>
</head>
<body>

<div class="dashboard">
    <div style="text-align:left">
        <div style="font-size:0.6rem; color:var(--primary); font-family:'Orbitron'">MINED WEALTH</div>
        <div id="total-value" class="wealth-val" onclick="resetWealth()">$0.00</div>
    </div>
    <h1 style="font-family:'Orbitron'; font-size: 1rem; color: var(--primary); margin:0;">RE-MINE</h1>
    <button id="loc-btn" class="btn" style="font-size: 1.2rem;" onclick="toggleLocation()">üìç</button>
</div>

<div id="chat-window">
    <div class="message ai-message">Stable Connection established. Upload hardware to begin analysis.</div>
</div>

<div class="input-container">
    <div class="control-bar">
        <div id="preview-msg">No files selected</div>
        <button id="track-toggle" class="toggle-btn active" onclick="toggleTracking()">TRACKING: ON</button>
    </div>
    <div id="preview-container" style="display:flex; gap:5px; margin-bottom:10px; overflow-x:auto;"></div>
    <div class="input-area">
        <input type="file" id="fileInput" accept="image/*" multiple hidden>
        <button class="btn" type="button" onclick="document.getElementById('fileInput').click()">üìé</button>
        <input type="text" id="userInput" placeholder="Message...">
        <button class="btn" type="button" onclick="sendMessage()">‚ûî</button>
    </div>
</div>

<script>
    let userLat = null, userLon = null;
    let isTracking = true;
    let totalMined = parseFloat(localStorage.getItem('minedWealth')) || 0;
    document.getElementById('total-value').innerText = `$${totalMined.toFixed(2)}`;

    function toggleTracking() {
        isTracking = !isTracking;
        const btn = document.getElementById('track-toggle');
        btn.innerText = isTracking ? "TRACKING: ON" : "TRACKING: OFF";
        btn.classList.toggle('active');
    }

    function resetWealth() {
        if(confirm("Reset wealth counter to $0.00?")) {
            totalMined = 0;
            localStorage.setItem('minedWealth', 0);
            document.getElementById('total-value').innerText = `$0.00`;
        }
    }

    function toggleLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                userLat = p.coords.latitude; userLon = p.coords.longitude;
                document.getElementById('loc-btn').style.color = "#03dac6";
                alert("Location Locked.");
            });
        }
    }

    fileInput.addEventListener('change', () => {
        previewContainer.innerHTML = '';
        const count = fileInput.files.length;
        document.getElementById('preview-msg').innerText = count > 0 ? `${count} files ready` : "No files selected";
        for (const f of fileInput.files) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(f);
            img.style.width = "45px"; img.style.height = "45px"; img.style.objectFit = "cover";
            img.style.borderRadius = "4px"; img.style.border = "1px solid var(--primary)";
            previewContainer.appendChild(img);
        }
    });

    async function sendMessage() {
        const textInput = document.getElementById('userInput');
        const text = textInput.value;
        const files = Array.from(fileInput.files);
        if (!text && files.length === 0) return;

        if (text) appendMessage(text, 'user-message');
        files.forEach(f => {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(f);
            img.style.width = '120px'; img.style.borderRadius = '8px'; img.style.alignSelf = 'flex-end';
            chatWindow.appendChild(img);
        });

        const formData = new FormData();
        formData.append('text', text);
        if (userLat) { formData.append('lat', userLat); formData.append('lon', userLon); }
        files.forEach(f => formData.append('files', f));

        textInput.value = ''; fileInput.value = '';
        previewContainer.innerHTML = '';
        document.getElementById('preview-msg').innerText = "No files selected";

        const loadingDiv = appendMessage("Connecting to AI Core...", 'ai-message');
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
            const res = await fetch('/chat', { method: 'POST', body: formData });
            const data = await res.json();
            
            if (isTracking) {
                const valMatch = data.response.match(/\$([0-9]+\.[0-9]{2})/);
                if (valMatch) {
                    totalMined += parseFloat(valMatch[1]);
                    localStorage.setItem('minedWealth', totalMined.toFixed(2));
                    document.getElementById('total-value').innerText = `$${totalMined.toFixed(2)}`;
                }
            }

            loadingDiv.innerHTML = formatAI(data.response);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        } catch (e) { loadingDiv.innerText = "Connection Failed. Check Server Logs."; }
    }

    function appendMessage(t, c) {
        const d = document.createElement('div'); d.className = `message ${c}`; d.innerText = t;
        chatWindow.appendChild(d); chatWindow.scrollTop = chatWindow.scrollHeight;
        return d;
    }

    function formatAI(t) {
        let h = t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        if (h.includes('|')) {
            const rows = h.split('<br>').filter(r => r.includes('|') && !r.includes('---'));
            let table = '<div class="table-container"><table>';
            rows.forEach((r, i) => {
                const cells = r.split('|').filter(c => c.trim());
                const tag = i === 0 ? 'th' : 'td';
                table += `<tr>${cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('')}</tr>`;
            });
            h = h.replace(/(\|.*?\|(<br>|$))+/g, table + '</table></div>');
        }
        return h;
    }
</script>
</body>
</html>
