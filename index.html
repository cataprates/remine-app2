<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RE-MINE Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #bb86fc; --bg: #121212; --surface: #1e1e1e; --text: #e0e0e0; --accent: #03dac6; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header with Trash Button */
        header { background: var(--surface); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); flex-shrink: 0; padding-top: env(safe-area-inset-top); }
        h1 { font-family: 'Orbitron', sans-serif; color: var(--primary); margin: 0; font-size: 1.3rem; letter-spacing: 2px; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--primary); padding: 5px; }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 130px; }
        .message { max-width: 90%; padding: 15px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; position: relative; }
        .user-message { align-self: flex-end; background: var(--primary); color: #000; font-weight: bold; }
        .ai-message { align-self: flex-start; background: var(--surface); border: 1px solid #333; width: 100%; box-sizing: border-box; }

        /* Copy Button Styling */
        .copy-btn { margin-top: 10px; background: #333; color: var(--primary); border: 1px solid var(--primary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-family: 'Inter', sans-serif; display: inline-flex; align-items: center; gap: 5px; }
        .copy-btn:active { background: var(--primary); color: #000; }

        .table-container { overflow-x: auto; margin: 10px 0; border: 1px solid #444; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; background: #252525; }
        td, th { padding: 10px; border-bottom: 1px solid #333; text-align: left; font-size: 0.8rem; }
        th { color: var(--primary); font-family: 'Orbitron'; font-size: 0.7rem; }

        /* Input Area - Camera + Gallery */
        .input-container { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface); padding: 15px; border-top: 1px solid #333; box-sizing: border-box; z-index: 1000; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .input-area { display: flex; align-items: center; gap: 8px; width: 100%; }
        input[type="text"] { flex: 1; background: #2b2b2b; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 20px; font-size: 16px; outline: none; min-width: 0; }
        .btn { background: none; border: none; cursor: pointer; color: var(--primary); font-size: 1.6rem; display: flex; align-items: center; padding: 5px; flex-shrink: 0; }
        
        #preview-container { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; }
        .preview-img { width: 45px; height: 45px; object-fit: cover; border-radius: 5px; border: 1px solid var(--primary); }
    </style>
</head>
<body>

<header>
    <div style="width: 30px;"></div> <h1>RE-MINE</h1>
    <button class="icon-btn" onclick="clearHistory()" title="Clear Chat History">üóëÔ∏è</button>
</header>

<div id="chat-window">
    <div class="message ai-message">System Online. Ready for hardware analysis. Use üì∑ to scan directly or üìé to upload.</div>
</div>

<div class="input-container">
    <div id="preview-container"></div>
    <div class="input-area">
        <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple hidden>
        <button class="btn" type="button" onclick="document.getElementById('cameraInput').click()">üì∑</button>
        
        <input type="file" id="fileInput" accept="image/*" multiple hidden>
        <button class="btn" type="button" onclick="document.getElementById('fileInput').click()" style="font-size: 1.4rem;">üìé</button>
        
        <input type="text" id="userInput" placeholder="Ask RE-MINE...">
        <button id="sendBtn" class="btn" type="button" onclick="sendMessage()">‚ûî</button>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const fileInput = document.getElementById('fileInput');
    const cameraInput = document.getElementById('cameraInput');
    const previewContainer = document.getElementById('preview-container');
    let selectedFiles = [];

    // --- CHAT HISTORY SYSTEM ---
    window.onload = function() {
        const savedChat = localStorage.getItem('remine_history');
        if (savedChat) {
            chatWindow.innerHTML = savedChat;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    };

    function saveHistory() {
        // Remove 'Thinking...' loading states before saving
        const contentToSave = chatWindow.innerHTML.replace(/<div class="message ai-message" id="loading-div">.*?<\/div>/g, '');
        localStorage.setItem('remine_history', contentToSave);
    }

    function clearHistory() {
        if (confirm("Delete all past analysis and start fresh?")) {
            localStorage.removeItem('remine_history');
            chatWindow.innerHTML = '<div class="message ai-message">History cleared. Ready for new scan.</div>';
        }
    }

    // --- PREVIEW HANDLING (Combines Camera and Gallery) ---
    function handleFiles(event) {
        const files = Array.from(event.target.files);
        selectedFiles = selectedFiles.concat(files);
        renderPreviews();
    }

    function renderPreviews() {
        previewContainer.innerHTML = '';
        selectedFiles.forEach(f => {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(f);
            img.className = 'preview-img';
            previewContainer.appendChild(img);
        });
    }

    fileInput.addEventListener('change', handleFiles);
    cameraInput.addEventListener('change', handleFiles);

    // --- COPY TO CLIPBOARD ---
    function copyText(buttonElement) {
        const messageDiv = buttonElement.parentElement;
        const textToCopy = messageDiv.innerText.replace('üìã Copy to Clipboard', '').trim();
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = buttonElement.innerText;
            buttonElement.innerText = '‚úÖ Copied!';
            setTimeout(() => { buttonElement.innerText = originalText; }, 2000);
        });
    }

    // --- SEND MESSAGE ---
    async function sendMessage() {
        const textInput = document.getElementById('userInput');
        const text = textInput.value;
        
        if (!text && selectedFiles.length === 0) return;

        if (text) appendMessage(text, 'user-message');
        selectedFiles.forEach(f => {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(f);
            img.style.width = '120px'; img.style.borderRadius = '8px'; img.style.alignSelf = 'flex-end';
            chatWindow.appendChild(img);
        });

        const formData = new FormData();
        formData.append('text', text);
        selectedFiles.forEach(f => formData.append('files', f));

        // Reset inputs
        textInput.value = '';
        fileInput.value = '';
        cameraInput.value = '';
        selectedFiles = [];
        previewContainer.innerHTML = '';

        // Add ID to loading div so we don't save it to history
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message ai-message';
        loadingDiv.id = 'loading-div';
        loadingDiv.innerText = "Analyzing...";
        chatWindow.appendChild(loadingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
            const res = await fetch('/chat', { method: 'POST', body: formData });
            if (!res.ok) throw new Error("Server communication failed");
            
            const data = await res.json();
            
            // Format AI text and add Copy Button
            const formattedHTML = formatAI(data.response);
            loadingDiv.removeAttribute('id'); // Remove loading ID
            loadingDiv.innerHTML = formattedHTML + '<br><button class="copy-btn" onclick="copyText(this)">üìã Copy to Clipboard</button>';
            
            saveHistory();
            chatWindow.scrollTop = chatWindow.scrollHeight;

        } catch (e) {
            loadingDiv.innerText = "Error: " + e.message;
            loadingDiv.removeAttribute('id');
        }
    }

    function appendMessage(t, c) {
        const d = document.createElement('div'); d.className = `message ${c}`; d.innerText = t;
        chatWindow.appendChild(d); 
        chatWindow.scrollTop = chatWindow.scrollHeight;
        saveHistory();
        return d;
    }

    function formatAI(t) {
        let h = t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        if (h.includes('|')) {
            const rows = h.split('<br>').filter(r => r.includes('|') && !r.includes('---'));
            let table = '<div class="table-container"><table>';
            rows.forEach((r, i) => {
                const cells = r.split('|').filter(c => c.trim());
                const tag = i === 0 ? 'th' : 'td';
                table += `<tr>${cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('')}</tr>`;
            });
            h = h.replace(/(\|.*?\|(<br>|$))+/g, table + '</table></div>');
        }
        return h;
    }
</script>
</body>
</html>
